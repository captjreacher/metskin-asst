<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Metamorphosis Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0f1115; --card:#171a21; --muted:#aab2c0; --text:#e6e9ef; --accent:#6ee7b7; --warn:#f59e0b; --err:#ef4444; }
    * { box-sizing: border-box; }
    body { margin:0; padding:24px; font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:var(--bg); color:var(--text); }
    .wrap { max-width:860px; margin:0 auto; }
    h2 { margin:0 0 8px; font-size:22px; }
    .card { background:var(--card); border:1px solid #232735; border-radius:12px; padding:16px; margin:12px 0; }
    label { display:block; margin:8px 0 4px; color:var(--muted); }
    textarea, input, select { width:100%; padding:10px 12px; background:#0f1218; color:var(--text); border:1px solid #2a3040; border-radius:10px; }
    textarea { min-height:80px; resize:vertical; }
    button { appearance:none; border:0; border-radius:10px; padding:10px 14px; background:#2b3346; color:var(--text); cursor:pointer; }
    button.primary { background:#39415a; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .row > * { flex:1; }
    .muted { color:var(--muted); }
    .ok { color:var(--accent); }
    .warn { color:var(--warn); }
    .err { color:var(--err); }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #2a3040; border-radius:999px; color:var(--muted); font-size:12px; }

    .messages { display:flex; flex-direction:column; gap:10px; max-height:520px; overflow:auto; padding:12px; border:1px solid #252a33; border-radius:12px; background:#0f1117; }
    .bubble { max-width:75%; padding:10px 14px; border-radius:14px; line-height:1.45; white-space:pre-wrap; word-wrap:break-word; box-shadow:0 1px 0 rgba(0,0,0,.2); }
    .bubble.user { align-self:flex-end; background:#22577a; color:#fff; border-bottom-right-radius:6px; }
    .bubble.assistant { align-self:flex-start; background:#1f2937; color:#e5e7eb; border-bottom-left-radius:6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Metamorphosis Assistant <span class="pill">web</span></h2>
    <div id="status" class="muted card">Starting…</div>

    <div id="chatBox" class="card" style="display:none">
      <div class="row" style="justify-content:space-between;">
        <div><b>Thread:</b> <span id="threadId" class="muted">–</span></div>
        <div><b>Status:</b> <span id="ready" class="warn">connecting…</span></div>
      </div>

      <div id="messages" class="messages" style="margin-top:12px"></div>

      <label style="margin-top:12px">Message</label>
      <textarea id="msg" placeholder="Type your message…"></textarea>

      <div class="row" style="margin-top:8px">
        <button id="btnSend" class="primary">Send</button>
        <button id="btnClear">Clear conversation</button>
      </div>
    </div>
  </div>

  <script>
    (async () => {
      const $status=document.getElementById('status');
      const $chat=document.getElementById('chatBox');
      const $ready=document.getElementById('ready');
      const $tid=document.getElementById('threadId');
      const $msg=document.getElementById('msg');
      const $msgs=document.getElementById('messages');

      let thread_id=null;
      const history=[]; const HISTORY_MAX=12;

      function addBubble(role,text){ const d=document.createElement('div'); d.className='bubble '+role; d.textContent=text||'(no content)'; $msgs.appendChild(d); $msgs.scrollTop=$msgs.scrollHeight; }
      function add(role,text){ history.push({role, text}); while(history.length>HISTORY_MAX) history.shift(); addBubble(role,text); }

      async function startThread(){
        $status.textContent='Starting chat…';
        const r=await fetch('/start-chat');
        const j=await r.json().catch(()=>({}));
        if(!r.ok||!j?.thread_id){ $status.innerHTML='<span class="err">Start failed</span>'; return false; }
        thread_id=j.thread_id; $tid.textContent=thread_id; $ready.textContent='ready'; $ready.className='ok'; $status.innerHTML='<span class="ok">Connected.</span> You can chat below.'; $chat.style.display='block'; return true;
      }

      async function sendMessage(text){
        if(!thread_id){ const ok=await startThread(); if(!ok) return; }
        $ready.textContent='thinking…'; $ready.className='warn';
        const r=await fetch('/send',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ thread_id, text }) });
        const j=await r.json().catch(()=>({}));
        if(!r.ok||j?.ok===false){ add('assistant','Oops: '+(j.error||'send failed')); $ready.textContent='error'; $ready.className='err'; return; }
        add('assistant', j.message || j.answer || '(no content)');
        $ready.textContent='ready'; $ready.className='ok';
      }

      document.getElementById('btnSend').onclick=()=>{ const t=$msg.value.trim(); if(!t) return; add('user',t); $msg.value=''; sendMessage(t); };
      document.getElementById('btnClear').onclick=()=>{ $msgs.innerHTML=''; };
      $msg.addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); document.getElementById('btnSend').click(); } });

      await startThread();
    })();
  </script>
</body>
</html>